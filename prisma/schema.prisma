// NotifyUs - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id        String   @id @default(cuid())
  name      String
  apiKey    String   @unique @default(cuid())
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         AccountUser[]
  domains       Domain[]
  segments      Segment[]
  notifications Notification[]
  endUsers      EndUser[]
}

model AccountUser {
  id        String   @id @default(cuid())
  accountId String
  email     String
  password  String
  name      String?
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, email])
  @@index([email])
}

// NextAuth required models
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuthUser {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  accountId     String?
  sessions      Session[]
  oauthAccounts OAuthAccount[]
}

model OAuthAccount {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  user              AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Domain {
  id        String   @id @default(cuid())
  accountId String
  hostname  String
  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, hostname])
}

// End users of the SaaS customer's app (identified via SDK)
model EndUser {
  id         String   @id @default(cuid())
  accountId  String
  externalId String
  email      String?
  attributes Json     @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  account     Account                  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  impressions NotificationImpression[]
  clicks      NotificationClick[]

  @@unique([accountId, externalId])
  @@index([accountId])
}

model Segment {
  id        String   @id @default(cuid())
  accountId String
  name      String
  filters   Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  rules   SegmentRule[]

  notificationSegments      NotificationSegment[]
  excludedFromNotifications NotificationExclusion[]
}

model SegmentRule {
  id        String @id @default(cuid())
  segmentId String
  field     String
  operator  String // "in", "not_in", "eq", "contains"
  value     Json   // array of strings

  segment Segment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String @id @default(cuid())
  accountId String
  name      String
  lang      String @default("en") // "en" | "ar"
  type      String @default("banner") // "banner" | "modal" | "toast"
  position  String @default("top") // "top" | "bottom" | "center"
  status    String @default("draft") // "draft" | "scheduled" | "active" | "ended"

  // Content
  title    String
  body     String  @db.Text
  ctaText  String?
  ctaUrl   String?
  imageUrl String?

  // Appearance
  backgroundColor String @default("#1a1a2e")
  textColor       String @default("#ffffff")
  ctaColor        String @default("#e94560")

  // Behavior
  autoDismissSeconds Int?
  isDismissable      Boolean @default(true)
  isSticky           Boolean @default(false)

  // Scheduling
  startsAt        DateTime?
  endsAt          DateTime?
  maxViewsPerUser Int?
  repeatPolicy    String    @default("once") // "once" | "every_load"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account     Account                  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  impressions NotificationImpression[]
  clicks      NotificationClick[]
  segments    NotificationSegment[]
  exclusions  NotificationExclusion[]

  @@index([accountId])
  @@index([status])
}

model NotificationSegment {
  notificationId String
  segmentId      String

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  segment      Segment      @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@id([notificationId, segmentId])
}

model NotificationExclusion {
  notificationId String
  segmentId      String

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  segment      Segment      @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@id([notificationId, segmentId])
}

model NotificationImpression {
  id             String   @id @default(cuid())
  notificationId String
  userId         String
  viewCount      Int      @default(1)
  firstSeenAt    DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  isRead         Boolean  @default(false)
  isDismissed    Boolean  @default(false)

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         EndUser      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([notificationId])
  @@index([userId])
}

model NotificationClick {
  id             String   @id @default(cuid())
  notificationId String
  userId         String
  clickedAt      DateTime @default(now())
  ctaUrlSnapshot String?

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         EndUser      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([notificationId])
}
